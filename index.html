<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Auto Drop Module â€” Web UI (Hold + Delay + Reset Fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root { --bg:#0b0f14; --card:#101722; --ink:#eaf1ff; --muted:#9bb1d6; --line:#1f2b3d; --accent:#7aa2ff; --ok:#35c96e; --warn:#ffc857; --err:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR}
    .wrap{display:grid;grid-template-columns:1.25fr 0.9fr;gap:14px;max-width:1200px;margin:18px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.28);padding:14px}
    #map{height:560px;border-radius:12px;overflow:hidden}
    h1{font-size:18px;margin:0 0 10px}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1726;border:1px solid var(--line)}
    .titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .stat-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .dot-ok{background:var(--ok)} .dot-err{background:var(--err)}

    .form{display:grid;grid-template-columns:auto 1fr;grid-row-gap:12px;grid-column-gap:12px;align-items:center}
    .label{color:#d9e6ff}
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .inline{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .with-unit{position:relative}
    .with-unit input{
      width:100%;padding:8px 56px 8px 10px;border:1px solid #2a3a56;border-radius:8px;background:#0e1520;color:var(--ink);outline:none
    }
    .unit{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      color:var(--muted);font-size:12px;pointer-events:none
    }

    .btnbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    button{background:#152238;color:var(--ink);border:1px solid #2a3a56;border-radius:10px;padding:9px 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#0b0f14;font-weight:700}
    button.ok{background:var(--ok);color:#06210f;border-color:transparent}
    button.warn{background:var(--warn);color:#1f1500;border-color:transparent}
    button:disabled{opacity:.55;cursor:not-allowed}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .log{height:210px;background:#0a0f18;border:1px solid var(--line);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace,Consolas,monospace;color:#d8e2ff}
    .hint{font-size:12px;color:#9bb1d6;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Map -->
    <div class="card">
      <div class="titlebar">
        <h1>Target Picker (ì§€ë„ í´ë¦­)</h1>
        <span class="pill">
          <span id="portDot" class="stat-dot dot-err"></span>
          <span id="portLbl">Disconnected</span>
        </span>
      </div>
      <div id="map"></div>
      <div class="hint">ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜, ì˜¤ë¥¸ìª½ ì¢Œí‘œë¥¼ ì…ë ¥í•˜ë©´ ì§€ë„/ë§ˆì»¤ê°€ ì´ë™í•©ë‹ˆë‹¤. (ìœ„ì„±/ì¼ë°˜ ì „í™˜ ê°€ëŠ¥)</div>
    </div>

    <!-- RIGHT: Form + Serial -->
    <div class="card">
      <h1>Auto Drop Module</h1>
      <div class="form">
        <div class="label">ëª©í‘œ ì¢Œí‘œ:</div>
        <div class="pair">
          <div class="with-unit"><input id="lat" type="number" step="0.000001" placeholder="ìœ„ë„"><span class="unit">deg</span></div>
          <div class="with-unit"><input id="lon" type="number" step="0.000001" placeholder="ê²½ë„"><span class="unit">deg</span></div>
        </div>

        <div class="label">ì†ë„:</div>
        <div class="with-unit"><input id="v" type="number" step="0.1" placeholder="ì ‘ê·¼ ì†ë„"><span class="unit">m/s</span></div>

        <div class="label">ê³ ë„:</div>
        <div class="with-unit"><input id="h" type="number" step="0.1" placeholder="íˆ¬í•˜ì‹œ ê³ ë„"><span class="unit">m</span></div>

        <div class="label">PWM MIN/MAX:</div>
        <div class="inline">
          <div class="with-unit"><input id="pmin" type="number" step="10" placeholder="MIN"><span class="unit">&micro;s</span></div>
          <div class="with-unit"><input id="pmax" type="number" step="10" placeholder="MAX"><span class="unit">&micro;s</span></div>
        </div>

        <!-- ğŸ”¥ ì—¬ê¸°ë¶€í„°: ìœ ì§€ ì‹œê°„ + ë”œë ˆì´ 2ì¹¸ -->
        <div class="label">ê°œí ìœ ì§€ ì‹œê°„:</div>
        <div class="with-unit">
          <input id="hold" type="number" step="0.1" placeholder="ì—´ë¦¼ ìœ ì§€ ì‹œê°„(ì´ˆ)">
          <span class="unit">s</span>
        </div>

        <div class="label">ê°œí ë”œë ˆì´:</div>
        <div class="with-unit">
          <input id="delay" type="number" step="0.1" placeholder="ì—´ê¸° ì „ ë”œë ˆì´(ì´ˆ)">
          <span class="unit">s</span>
        </div>
        <!-- ğŸ”¥ ì—¬ê¸°ê¹Œì§€ -->

        <div class="label">íˆ¬í•˜ë¬¼ ì¤‘ëŸ‰:</div>
        <div class="with-unit"><input id="mass" type="number" step="0.01" placeholder="ì˜µì…˜"><span class="unit">kg</span></div>
      </div>

      <div class="btnbar">
        <button id="btnConnect" class="ok">ì‹œë¦¬ì–¼ ì—°ê²°</button>
        <button id="btnDisconnect" class="warn" disabled>ì—°ê²° í•´ì œ</button>
        <button id="btnSend" class="primary">íŒŒë¼ë¯¸í„° ì „ì†¡</button>
        <button id="btnReset">ë¦¬ì…‹</button>
      </div>

      <div class="hr"></div>
      <div class="hint">â€» ê°œí <b>ìœ ì§€ ì‹œê°„</b>ê³¼ <b>ë”œë ˆì´</b>ëŠ” ëª¨ë‘ <b>ì´ˆ(s)</b> ë‹¨ìœ„ë¡œ ì…ë ¥ë˜ë©°, ê·¸ëŒ€ë¡œ ì•„ë‘ì´ë…¸ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.</div>
      <div class="hint">ì•„ë˜ëŠ” ì•„ë‘ì´ë…¸ê°€ ë³´ë‚´ëŠ” ì‹œë¦¬ì–¼ ë¡œê·¸ì…ë‹ˆë‹¤.</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // ----- ì´ˆê¸° ì¢Œí‘œ -----
    const INIT = { lat: 37.8765842, lon: 127.1577533 };

    // ---------- Map with Satellite ----------
    const map = L.map('map', { zoomControl: true }).setView([INIT.lat, INIT.lon], 16);

    // ì¼ë°˜ ì§€ë„ (OSM)
    const baseOSM = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: '&copy; OpenStreetMap' }
    );

    // ìœ„ì„± ì§€ë„ (Esri World Imagery)
    const baseSAT = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 19, attribution: 'Tiles &copy; Esri' }
    );

    // ê¸°ë³¸ì€ ìœ„ì„±
    baseSAT.addTo(map);
    L.control.layers({ 'ìœ„ì„±': baseSAT, 'ì¼ë°˜ì§€ë„': baseOSM }).addTo(map);

    let marker = null;
    map.on('click', (e) => { const { lat, lng } = e.latlng; setLatLon(lat, lng); moveMarker(lat, lng, false); });

    function moveMarker(lat, lon, center=true){
      if (marker) marker.setLatLng([lat, lon]);
      else marker = L.marker([lat, lon]).addTo(map);
      center ? map.setView([lat, lon]) : map.panTo([lat, lon]);
    }

    function setLatLon(lat, lon){
      latI.value = lat.toFixed(8);
      lonI.value = lon.toFixed(8);
    }

    // ---------- UI helpers ----------
    const logEl = document.getElementById('log');
    function log(msg, color){
      const d=document.createElement('div');
      if(color)d.style.color=color;
      d.textContent=msg;
      logEl.appendChild(d);
      logEl.scrollTop=logEl.scrollHeight;
    }

    const portDot = document.getElementById('portDot');
    const portLbl = document.getElementById('portLbl');
    const btnDisconnect = document.getElementById('btnDisconnect');

    function setPortStatus(connected){
      portDot.className = 'stat-dot ' + (connected ? 'dot-ok' : 'dot-err');
      portLbl.textContent = connected ? 'Connected' : 'Disconnected';
      btnDisconnect.disabled = !connected;
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // ---------- Form refs ----------
    const latI = document.getElementById('lat');
    const lonI = document.getElementById('lon');
    const vI   = document.getElementById('v');
    const hI   = document.getElementById('h');
    const pminI= document.getElementById('pmin');
    const pmaxI= document.getElementById('pmax');

    const holdI = document.getElementById('hold');   // ê°œí ìœ ì§€ ì‹œê°„ (ì´ˆ)
    const delayI= document.getElementById('delay');  // ê°œí ë”œë ˆì´ (ì´ˆ)

    const massI= document.getElementById('mass');

    // ---------- ì…ë ¥ ì¢Œí‘œ â†’ ì§€ë„ ë™ê¸°í™” ----------
    function isValidLatLon(lat, lon){
      return Number.isFinite(lat) && Number.isFinite(lon) &&
             lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
    }

    function updateMapFromInputs(center=true){
      const lat = parseFloat(latI.value);
      const lon = parseFloat(lonI.value);
      if (isValidLatLon(lat, lon)) moveMarker(lat, lon, center);
    }

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    const debouncedUpdate = debounce(()=>updateMapFromInputs(false), 400);

    latI.addEventListener('input', debouncedUpdate);
    lonI.addEventListener('input', debouncedUpdate);
    latI.addEventListener('change', ()=>updateMapFromInputs(true));
    lonI.addEventListener('change', ()=>updateMapFromInputs(true));
    [latI, lonI].forEach(el => el.addEventListener('keydown', e => { if (e.key === 'Enter') updateMapFromInputs(true); }));

    // ---------- Web Serial ----------
    let port = null;
    let reader = null;
    let writer = null;
    const encoder = new TextEncoder();
    let closing = false;

    function portOpen() { return port && port.readable && port.writable && writer && reader; }

    function canSend(){
      if (closing) { log('> [WARN] í•´ì œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œìš”.', '#ffd479'); return false; }
      if (!writer) { log('> [ERR] í¬íŠ¸ê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.', '#ff8b8b'); return false; }
      return true;
    }

    async function connectSerial(){
      if(!('serial' in navigator)){ alert('Chrome/Edgeì—ì„œ https ë˜ëŠ” localhostë¡œ ì‹¤í–‰í•˜ì„¸ìš”.'); return; }
      try{
        const ports = await navigator.serial.getPorts(); // ê¶Œí•œ ìˆëŠ” í¬íŠ¸
        port = ports[0] || await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        writer = port.writable.getWriter();
        reader = port.readable.getReader();
        setPortStatus(true);
        log('> [INFO] ì‹œë¦¬ì–¼ ì—°ê²°ë¨', '#9be5a3');
        readLoop();
      }catch(err){
        console.error(err);
        log('> [ERR] ì—°ê²° ì‹¤íŒ¨: '+err.message, '#ff8b8b');
        await safeTearDown();
        setPortStatus(false);
      }
    }

    async function disconnectSerial(){
      closing = true;
      try{
        if (reader){
          try{ await reader.cancel(); }catch{}
          try{ reader.releaseLock(); }catch{}
          reader = null;
        }
        if (writer){
          try{ await writer.close(); }catch{}
          try{ writer.releaseLock(); }catch{}
          writer = null;
        }
        if (port){ try{ await port.close(); }catch{} }
        port = null;

        setPortStatus(false);
        log('> [INFO] ì—°ê²° í•´ì œ', '#ffd479');
        await sleep(250);
      }finally{
        closing = false;
      }
    }

    async function safeTearDown(){
      try{ if(reader){ await reader.cancel(); } }catch{}
      try{ if(reader){ reader.releaseLock(); } }catch{}
      reader = null;
      try{ if(writer){ await writer.close(); } }catch{}
      try{ if(writer){ writer.releaseLock(); } }catch{}
      writer = null;
      try{ if(port){ await port.close(); } }catch{}
      port = null;
    }

    async function tryAutoReconnect(){
      try{
        const ports = await navigator.serial.getPorts();
        if (!ports.length) return false;
        port = ports[0];
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        reader = port.readable.getReader();
        setPortStatus(true);
        readLoop();
        log('> [INFO] ë¦¬ì…‹ í›„ ìë™ ì¬ì—°ê²° ì™„ë£Œ', '#9be5a3');
        return true;
      }catch(e){
        log('> [WARN] ìë™ ì¬ì—°ê²° ì‹¤íŒ¨: '+e.message, '#ffd479');
        await safeTearDown();
        setPortStatus(false);
        return false;
      }
    }

    async function readLoop(){
      while(reader){
        try{
          const { value, done } = await reader.read();
          if (done) break;
          if (value){
            const text = new TextDecoder().decode(value);
            text.split(/\r?\n/).forEach(l=>l&&log(l));
          }
        }catch{ break; }
      }
    }

    async function sendLine(s){
      if (!canSend()) return;
      try{
        const data = encoder.encode(s.trim()+'\n');
        await writer.write(data);
        log('> '+s, '#9bb1d6');
      }catch(err){
        log('> [ERR] ì „ì†¡ ì‹¤íŒ¨: '+err.message, '#ff8b8b');
      }
    }

    navigator.serial.addEventListener('disconnect', async ()=>{
      log('> [WARN] ì¥ì¹˜ ì—°ê²° í•´ì œ ê°ì§€', '#ffd479');
      await safeTearDown();
      setPortStatus(false);
    });
    navigator.serial.addEventListener('connect', ()=>{
      log('> [INFO] ì¥ì¹˜ ì—°ê²° ê°ì§€(ê¶Œí•œ ìˆìŒ). â€œì‹œë¦¬ì–¼ ì—°ê²°â€ë¡œ ì¬ì—°ê²°í•˜ì„¸ìš”.', '#9be5a3');
    });

    // ---------- íŒŒë¼ë¯¸í„° ë¼ì¸ ìƒì„± (holdSec / delaySec ëª¨ë‘ ì´ˆ ë‹¨ìœ„) ----------
    function buildParamLine(){
      const lat  = parseFloat(latI.value);
      const lon  = parseFloat(lonI.value);
      const v    = parseFloat(vI.value);
      const h    = parseFloat(hI.value);
      const pmin = parseInt(pminI.value, 10);
      const pmax = parseInt(pmaxI.value, 10);

      const holdSec  = parseFloat(holdI.value);   // ê°œí ìœ ì§€ ì‹œê°„ (ì´ˆ)
      const delaySec = parseFloat(delayI.value);  // ê°œí ë”œë ˆì´ (ì´ˆ)

      const massStr = massI.value.trim();

      if ([lat, lon, v, h, pmin, pmax, holdSec, delaySec].some(x => Number.isNaN(x))){
        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        return null;
      }

      const latStr = lat.toFixed(6);
      const lonStr = lon.toFixed(6);

      // ì´ˆ ë‹¨ìœ„ ê·¸ëŒ€ë¡œ ì „ì†¡ (ì•„ë‘ì´ë…¸ì—ì„œ atofë¡œ ë°›ì•„ì„œ ì´ˆë¡œ ì‚¬ìš©)
      const holdStr  = holdSec.toString();
      const delayStr = delaySec.toString();

      if (!massStr.length)
        return `${latStr} ${lonStr} ${v} ${h} ${pmin} ${pmax} ${holdStr} ${delayStr}`;

      const mass = parseFloat(massStr);
      if (Number.isNaN(mass)){
        alert('íˆ¬í•˜ë¬¼ ì¤‘ëŸ‰ ê°’ì„ í™•ì¸í•˜ì„¸ìš”.');
        return null;
      }
      return `${latStr} ${lonStr} ${v} ${h} ${pmin} ${pmax} ${holdStr} ${delayStr} ${mass}`;
    }

    // ---------- Reset (robust) ----------
    async function resetForm(){
      // UI ì¢Œí‘œ ì´ˆê¸°í™” + ì§€ë„/ë§ˆì»¤ ì´ë™
      setLatLon(INIT.lat, INIT.lon);
      moveMarker(INIT.lat, INIT.lon, true);

      // ë‚˜ë¨¸ì§€ ì…ë ¥ ì´ˆê¸°í™”
      vI.value = '';
      hI.value = '';
      pminI.value = '';
      pmaxI.value = '';
      holdI.value = '';
      delayI.value = '';
      massI.value = '';

      log('> [UI] í¼ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.', '#9bb1d6');

      // ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¥ì¹˜ ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸ í›„ clear ì „ì†¡
      if (writer){
        const doClear = confirm('ì¥ì¹˜ë„ ì´ˆê¸°í™”(clear) ëª…ë ¹ì„ ë³´ë‚¼ê¹Œìš”?');
        if (doClear){
          try { await sendLine('clear'); } catch {}
          // ì¥ì¹˜ê°€ ì¬ë¶€íŒ…/ì¬ì—´ê±°ë˜ë©° ì—°ê²°ì´ ëŠê¸¸ ìˆ˜ ìˆìŒ â†’ ìë™ ë³µêµ¬ ì‹œë„
          await sleep(200);
          if (!portOpen()){
            await safeTearDown();
            await tryAutoReconnect(); // ê¶Œí•œ ìˆìœ¼ë©´ ìë™ ì¬ì—°ê²°
          }
        }
      }
    }

    // ---------- Buttons ----------
    document.getElementById('btnConnect').addEventListener('click', connectSerial);
    document.getElementById('btnDisconnect').addEventListener('click', disconnectSerial);
    document.getElementById('btnSend').addEventListener('click', async ()=>{
      const line = buildParamLine();
      if (line) await sendLine(line);
    });
    document.getElementById('btnReset').addEventListener('click', resetForm);

    // ì´ˆê¸° í‘œì‹œ
    moveMarker(INIT.lat, INIT.lon, true);
    setLatLon(INIT.lat, INIT.lon);
    setPortStatus(false);
  </script>
</body>
</html>
