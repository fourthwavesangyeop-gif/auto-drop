<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Auto Drop Module — Web UI</title>

  <!-- ✅ Viewport Lock -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <!-- ✅ Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          crossorigin=""></script>

  <!-- ✅ UI Style -->
  <style>
    :root {
      --bg:#0b0f14; --card:#101722; --ink:#eaf1ff;
      --muted:#9bb1d6; --line:#1f2b3d;
      --accent:#7aa2ff; --ok:#35c96e;
      --warn:#ffc857; --err:#ff6b6b;
      --ble:#4263eb;  --load:#4dabf7;
    }

    * { box-sizing:border-box }

    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:15px/1.45 system-ui, -apple-system, Segoe UI,
            Roboto, Apple SD Gothic Neo, Noto Sans KR;
    }

    /* ===== Layout ===== */
    .wrap {
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:14px;
      max-width:2000px;
      margin:18px auto;
      padding:0 20px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 4px 18px rgba(0,0,0,.28);
      padding:14px;
    }

    .map-card { display:flex; flex-direction:column; }

    #map {
      width:100%;
      aspect-ratio:1/1;
      border-radius:12px;
      overflow:hidden;
    }

    .titlebar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }

    h1 { font-size:18px; margin:0 0 10px }

    .pill {
      padding:6px 10px;
      border-radius:999px;
      background:#0f1726;
      border:1px solid var(--line);
      font-size:13px;
    }

    .stat-dot {
      width:8px; height:8px;
      border-radius:50%;
      display:inline-block;
      margin-right:6px;
    }
    .dot-ok { background:var(--ok) }
    .dot-err{ background:var(--err)}

    .label { font-size:13px; color:var(--muted) }
    .hint  { margin-top:6px; font-size:12px; color:var(--muted)}

    /* ===== Form ===== */
    .form {
      display:grid;
      grid-template-columns:auto 1fr;
      gap:12px;
      align-items:center;
    }

    .pair { display:grid; grid-template-columns:1fr 1fr; gap:10px }

    .pwm-list { display:flex; flex-direction:column; gap:10px }

    .with-unit { position:relative }

    .with-unit input {
      width:100%;
      padding:10px 48px 10px 12px;
      border:1px solid #2a3a56;
      border-radius:8px;
      background:#0e1520;
      color:var(--ink);
      font-size:16px;
    }

    .unit {
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:12px;
      color:var(--muted);
    }

    /* ===== Buttons ===== */
    button {
      background:#152238;
      color:var(--ink);
      border-radius:10px;
      padding:9px 12px;
      border:1px solid #2a3a56;
      cursor:pointer;
      font-size:14px;
      white-space:nowrap;
    }

    .ok{background:var(--ok);color:#06210f;border:none}
    .blebtn{background:var(--ble);color:#fff;border:none}
    .primary{background:var(--accent);color:#0b0f14;border:none}
    .loadbtn{background:var(--load);color:#0b0f14;border:none}
    .warn{background:var(--warn);color:#2b1a00;border:none}

    .btnbar {
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .log {
      height:220px;
      background:#0a0f18;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      overflow:auto;
      font-family:ui-monospace, Consolas, monospace;
      font-size:12px;
    }

    .radius-label-inner {
      background:rgba(0,0,0,.7);
      color:#7aa2ff;
      padding:4px 8px;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      border:1px solid #2a3a56;
    }

    /* ✅ Mobile */
    @media (max-width:900px) and (orientation:portrait){
      .wrap{grid-template-columns:1fr;padding:0 10px}
      #map{height:260px}
      .btnbar{display:grid;grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>

<body>

  <!-- ================= MAIN ================= -->
  <div class="wrap">

    <!-- ===== MAP ===== -->
    <div class="card map-card">
      <div class="titlebar">
        <h1>Target Picker</h1>
        <span class="pill">
          <span id="connDot" class="stat-dot dot-err"></span>
          <span id="connLbl">Disconnected</span>
        </span>
      </div>
      <div id="map"></div>
      <div class="hint">지도를 클릭하면 좌표가 자동 설정됩니다.</div>
    </div>

    <!-- ===== PANEL ===== -->
    <div class="card panel-card">
      <h1>Auto Drop Module</h1>

      <div class="form">
        <div class="label">목표 좌표:</div>
        <div class="pair">
          <div class="with-unit"><input id="lat"><span class="unit">deg</span></div>
          <div class="with-unit"><input id="lon"><span class="unit">deg</span></div>
        </div>

        <div class="label">속도:</div>
        <div class="with-unit"><input id="v"><span class="unit">m/s</span></div>

        <div class="label">고도:</div>
        <div class="with-unit"><input id="h"><span class="unit">m</span></div>

        <div class="label">유지시간:</div>
        <div class="with-unit"><input id="hold"><span class="unit">s</span></div>

        <div class="label">오프셋:</div>
        <div class="with-unit"><input id="offset"><span class="unit">m</span></div>

        <div class="label">중량:</div>
        <div class="with-unit"><input id="mass"><span class="unit">kg</span></div>
      </div>

      <div class="pwm-list">
        <input id="pwm1"><input id="pwm2"><input id="pwm3">
        <input id="pwm4"><input id="pwm5"><input id="pwm6">
        <input id="pwm7">
      </div>

      <div class="btnbar">
        <button id="btnConnect" class="ok">시리얼</button>
        <button id="btnBLE" class="blebtn">BLE</button>
        <button id="btnSend" class="primary">전송</button>
        <button id="btnLoad" class="loadbtn">로드</button>
        <button id="btnDisconnect" class="warn">해제</button>
        <button id="btnReset">리셋</button>
      </div>

      <div class="log" id="log"></div>
    </div>

  </div>

  <!-- ✅ SCRIPT (기능 유지, 위치만 하단으로 정리) -->
  <script>
/* ===========================================================
   ✅ 0. GLOBAL CONST / INIT
=========================================================== */
const INIT = { lat:37.8765842, lon:127.1577533 };
const G = 9.80665;

/* ===========================================================
   ✅ 1. DOM ELEMENTS
=========================================================== */
const latI = document.getElementById("lat");
const lonI = document.getElementById("lon");
const vI   = document.getElementById("v");
const hI   = document.getElementById("h");
const holdI= document.getElementById("hold");
const offsetI = document.getElementById("offset");
const massI   = document.getElementById("mass");

const pwmI = [
  pwm1,pwm2,pwm3,pwm4,pwm5,pwm6,pwm7
].map(id => document.getElementById(id));

const logEl = document.getElementById("log");
const connDot = document.getElementById("connDot");
const connLbl = document.getElementById("connLbl");
const btnDisconnect = document.getElementById("btnDisconnect");

/* ===========================================================
   ✅ 2. VIEWPORT LOCK
=========================================================== */
function lockViewport(){
  const vp = document.querySelector("meta[name=viewport]");
  if(vp){
    vp.setAttribute("content",
      "width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no");
  }
}

/* ===========================================================
   ✅ 3. LOG SYSTEM
=========================================================== */
function log(msg, color){
  const d = document.createElement("div");
  if(color) d.style.color = color;
  d.textContent = msg;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

/* ===========================================================
   ✅ 4. MAP SYSTEM
=========================================================== */
let map, marker, dropCircle, radiusLabel;

function initMap(){
  map = L.map("map").setView([INIT.lat, INIT.lon], 16);

  L.tileLayer(
   "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
   { maxZoom:19 }).addTo(map);

  moveMarker(INIT.lat, INIT.lon, true);

  map.on("click", e=>{
    const lat = +e.latlng.lat.toFixed(7);
    const lon = +e.latlng.lng.toFixed(7);
    setLatLon(lat,lon);
    moveMarker(lat,lon,false);
    updateRadiusCircleFromInputs();
  });
}

function moveMarker(lat,lon,center=true){
  if(marker) marker.setLatLng([lat,lon]);
  else marker = L.marker([lat,lon]).addTo(map);
  center ? map.setView([lat,lon]) : map.panTo([lat,lon]);
}

function drawDropCircle(lat,lon,r){
  if(dropCircle) map.removeLayer(dropCircle);
  if(r<=0) return;
  dropCircle = L.circle([lat,lon],{
    radius:r,color:"#7aa2ff",
    fillColor:"#7aa2ff",fillOpacity:0.15
  }).addTo(map);
}

function updateRadiusLabel(lat,lon,r){
  if(radiusLabel) map.removeLayer(radiusLabel);
  if(r<=0) return;

  radiusLabel = L.marker([lat,lon],{
    icon:L.divIcon({
      className:"radius-label",
      html:`<div class="radius-label-inner">${r.toFixed(1)} m</div>`,
      iconAnchor:[40,45]
    })
  }).addTo(map);
}

/* ===========================================================
   ✅ 5. DROP PHYSICS
=========================================================== */
function estimateVT(m){
  if(m<=0.3) return 18;
  if(m<=0.5) return 22.5;
  if(m<=0.7) return 26.7;
  if(m<=1.0) return 28.5;
  if(m<=2.0) return 32;
  return 38;
}

function computeFallTime(h, vt){
  return Math.sqrt((2*h)/G);
}

function computeDropRadius(v,h,m){
  return v * computeFallTime(h, estimateVT(m)) * 1.22;
}

function updateRadiusCircleFromInputs(){
  const lat = parseFloat(latI.value);
  const lon = parseFloat(lonI.value);
  const v   = parseFloat(vI.value);
  const h   = parseFloat(hI.value);
  const o   = parseFloat(offsetI.value||0);
  const m   = parseFloat(massI.value);

  if([lat,lon,v,h,m].some(isNaN)) return;

  const base = computeDropRadius(v,h,m);
  const eff  = base + o;

  drawDropCircle(lat,lon,eff);
  updateRadiusLabel(lat,lon,eff);
}

/* ===========================================================
   ✅ 6. CONNECTION STATUS
=========================================================== */
let serialConnected=false, bleConnected=false;

function updateConnStatus(){
  const on = serialConnected || bleConnected;
  connDot.className = "stat-dot " + (on?"dot-ok":"dot-err");
  connLbl.textContent = on ? "Connected":"Disconnected";
  btnDisconnect.disabled = !on;
}

/* ===========================================================
   ✅ 7. SERIAL SYSTEM
=========================================================== */
let port, reader, writer;
const encoder = new TextEncoder();
const decoder = new TextDecoder();

async function connectSerial(){
  if(!("serial" in navigator)){
    alert("Chrome 전용 기능입니다");
    return;
  }

  try{
    port = await navigator.serial.requestPort();
    await port.open({baudRate:115200});
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    serialConnected = true;
    updateConnStatus();
    log("> Serial Connected", "#9be5a3");
    readLoop();
  }catch(e){
    log("> Serial ERR " + e, "#ff8b8b");
  }
}

async function readLoop(){
  let buffer="";
  while(reader){
    const {value,done} = await reader.read();
    if(done) break;
    buffer += decoder.decode(value);
    const lines = buffer.split(/\r?\n/);
    buffer = lines.pop();
    lines.forEach(l=>log(l));
  }
}

async function sendLine(s){
  if(!writer){
    log("> Serial Not Connected", "#ff8b8b"); return;
  }
  await writer.write(encoder.encode(s+"\n"));
  log("> Serial: "+s, "#9bb1d6");
}

/* ===========================================================
   ✅ 8. BLE SYSTEM
=========================================================== */
let bleDevice, bleCharacteristic;

const SERVICE_UUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHARACTERISTIC_UUID_RX="6e400002-b5a3-f393-e0a9-e50e24dcca9e";

async function connectBLE(){
  try{
    bleDevice = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true, optionalServices:[SERVICE_UUID]
    });

    const server = await bleDevice.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_RX);

    bleConnected = true;
    updateConnStatus();
    log("> BLE Connected", "#7aa2ff");
  }catch(e){
    log("> BLE ERR "+e, "#ff8b8b");
  }
}

async function bleSend(obj){
  if(!bleCharacteristic) return;
  const msg = JSON.stringify(obj);
  await bleCharacteristic.writeValue(new TextEncoder().encode(msg));
  log("> BLE: "+msg, "#7aa2ff");
}

/* ===========================================================
   ✅ 9. PARAM PACK
=========================================================== */
function buildParamLine(){
  const pwm = pwmI.map(v=>parseInt(v.value)||1500);
  return [
    latI.value, lonI.value,
    vI.value, hI.value, holdI.value,
    offsetI.value||0, massI.value,
    ...pwm
  ].join(" ");
}

function buildBleObject(){
  return {
    lat:latI.value, lon:lonI.value,
    v:+vI.value||0, h:+hI.value||0,
    hold:+holdI.value||0.5,
    offset:+offsetI.value||0,
    mass:+massI.value||0.7,
    pwm:pwmI.map(v=>parseInt(v.value)||1500)
  };
}

/* ===========================================================
   ✅ 10. BUTTON EVENTS
=========================================================== */
btnConnect.onclick = connectSerial;
btnBLE.onclick     = connectBLE;

btnSend.onclick = ()=>{
  if(serialConnected) sendLine(buildParamLine());
  if(bleConnected)    bleSend(buildBleObject());
};

btnReset.onclick = ()=>{
  setLatLon(INIT.lat, INIT.lon);
  pwmI.forEach(v=>v.value="");
  updateRadiusCircleFromInputs();
};

/* ===========================================================
   ✅ 11. INPUT LIVE REFRESH
=========================================================== */
[vI,hI,offsetI,massI].forEach(v=>
  v.addEventListener("input", updateRadiusCircleFromInputs));

function setLatLon(lat,lon){
  latI.value = lat.toFixed(7);
  lonI.value = lon.toFixed(7);
}

/* ===========================================================
   ✅ 12. INIT
=========================================================== */
initMap();
setLatLon(INIT.lat, INIT.lon);
updateConnStatus();
lockViewport();
</script>

</body>
</html>
