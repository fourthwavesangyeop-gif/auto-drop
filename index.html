<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Auto Drop Module — Web UI (Fixed 15 Params)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          crossorigin=""></script>

  <style>
    :root {
      --bg:#0b0f14;
      --card:#101722;
      --ink:#eaf1ff;
      --muted:#9bb1d6;
      --line:#1f2b3d;
      --accent:#7aa2ff;
      --ok:#35c96e;
      --warn:#ffc857;
      --err:#ff6b6b;
    }

    * { box-sizing:border-box }

    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR;
    }

    .wrap {
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:14px;
      max-width:2000px;
      margin:18px auto;
      padding:0 20px;
    }

    .card {
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 4px 18px rgba(0,0,0,.28);
      padding:14px;
    }

    /* 정사각형 지도 */
    .card.map-card {
      display:flex;
      flex-direction:column;
      height:100%;
    }
    #map {
      width:100%;
      aspect-ratio:1 / 1;
      border-radius:12px;
      overflow:hidden;
    }

    h1 { font-size:18px; margin:0 0 10px; }
    .pill {
      padding:6px 10px;
      border-radius:999px;
      background:#0f1726;
      border:1px solid var(--line);
    }
    .titlebar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }

    .stat-dot {
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:6px;
    }
    .dot-ok { background:var(--ok) }
    .dot-err { background:var(--err) }

    /* Form ---------------------------- */
    .form {
      display:grid;
      grid-template-columns:auto 1fr;
      gap:12px;
      align-items:center;
    }

    .pair {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .inline {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
    }

    .with-unit { position:relative; }

    /* remove spin buttons */
    .with-unit input[type=number]{
      -moz-appearance:textfield;
    }
    .with-unit input::-webkit-inner-spin-button,
    .with-unit input::-webkit-outer-spin-button {
      -webkit-appearance:none;
      margin:0;
    }

    .with-unit input {
      width:100%;
      padding:10px 48px 10px 12px;
      border:1px solid #2a3a56;
      border-radius:8px;
      background:#0e1520;
      color:var(--ink);
    }

    .unit {
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:12px;
      color:var(--muted);
    }

    button {
      background:#152238;
      color:var(--ink);
      border-radius:10px;
      padding:9px 12px;
      border:1px solid #2a3a56;
      cursor:pointer;
    }
    .primary { background:var(--accent); color:#0b0f14; font-weight:700; }
    .ok { background:var(--ok); color:#06210f; border:none; font-weight:700; }
    .warn { background:var(--warn); color:#1f1500; border:none; }
    button:disabled { opacity:0.55; cursor:not-allowed; }

    .btnbar { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .hr { height:1px; background:var(--line); margin:12px 0; }

    .log {
      height:220px;
      background:#0a0f18;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      overflow:auto;
      font-family:ui-monospace,Consolas,monospace;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LEFT (MAP) ---------------------------------------------------- -->
  <div class="card map-card">
    <div class="titlebar">
      <h1>Target Picker</h1>
      <span class="pill">
        <span id="portDot" class="stat-dot dot-err"></span>
        <span id="portLbl">Disconnected</span>
      </span>
    </div>

    <div id="map"></div>
    <div class="hint">지도를 클릭하면 우측에 좌표가 입력됩니다.</div>
  </div>

  <!-- RIGHT (FORM) -------------------------------------------------- -->
  <div class="card">
    <h1>Auto Drop Module</h1>

    <div class="form">

      <div class="label">목표 좌표:</div>
      <div class="pair">
        <div class="with-unit">
          <input id="lat" type="text">
          <span class="unit">deg</span>
        </div>
        <div class="with-unit">
          <input id="lon" type="text">
          <span class="unit">deg</span>
        </div>
      </div>

      <div class="label">속도:</div>
      <div class="with-unit">
        <input id="v" type="number" step="0.1">
        <span class="unit">m/s</span>
      </div>

      <div class="label">고도:</div>
      <div class="with-unit">
        <input id="h" type="number" step="0.1">
        <span class="unit">m</span>
      </div>

      <div class="label">개폐 유지시간:</div>
      <div class="with-unit">
        <input id="hold" type="number" step="0.01">
        <span class="unit">s</span>
      </div>

      <div class="label">투하 반경 오차:</div>
      <div class="with-unit">
        <input id="offset" type="number" step="0.1">
        <span class="unit">m</span>
      </div>

      <div class="label">투하물 중량:</div>
      <div class="with-unit">
        <input id="mass" type="number" step="0.01">
        <span class="unit">kg</span>
      </div>

      <div class="label">PWM(0~6):</div>
      <div class="inline">
        <div class="with-unit"><input id="pwm1"><span class="unit">µs</span></div>
        <div class="with-unit"><input id="pwm2"><span class="unit">µs</span></div>
        <div class="with-unit"><input id="pwm3"><span class="unit">µs</span></div>
        <div class="with-unit"><input id="pwm4"><span class="unit">µs</span></div>
        <div class="with-unit"><input id="pwm5"><span class="unit">µs</span></div>
        <div class="with-unit"><input id="pwm6"><span class="unit">µs</span></div>
        <div class="with-unit"><input id="pwm7"><span class="unit">µs</span></div>
      </div>

    </div>

    <div class="btnbar">
      <button id="btnConnect" class="ok">시리얼 연결</button>
      <button id="btnDisconnect" class="warn" disabled>해제</button>
      <button id="btnSend" class="primary">파라미터 전송</button>
      <button id="btnReset">리셋</button>
    </div>

    <div class="hr"></div>
    <div class="hint">입력값 그대로 아두이노로 전송됩니다.</div>
    <div id="log" class="log"></div>
  </div>
</div>

<!-- SCRIPT -------------------------------------------------------- -->
<script>
/* -------------------------------------------------
   Leaflet Map
------------------------------------------------- */
const INIT = { lat:37.8765842, lon:127.1577533 };
let dropCircle=null;

const map=L.map("map").setView([INIT.lat,INIT.lon],16);

const baseSAT=L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:19}
).addTo(map);

const baseOSM=L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {maxZoom:19}
);
L.control.layers({위성:baseSAT,일반지도:baseOSM}).addTo(map);

let marker=null;

function moveMarker(lat,lon,center=true){
  if(marker) marker.setLatLng([lat,lon]);
  else marker=L.marker([lat,lon]).addTo(map);
  center ? map.setView([lat,lon]) : map.panTo([lat,lon]);
}

map.on("click",e=>{
  setLatLon(e.latlng.lat,e.latlng.lng);
  moveMarker(e.latlng.lat,e.latlng.lng,false);
  updateRadiusCircleFromInputs();
});

/* -------------------------------------------------
   Inputs
------------------------------------------------- */
const latI=document.getElementById("lat");
const lonI=document.getElementById("lon");
const vI=document.getElementById("v");
const hI=document.getElementById("h");
const holdI=document.getElementById("hold");
const offsetI=document.getElementById("offset");
const massI=document.getElementById("mass");

const pwmI=[
  document.getElementById("pwm1"),
  document.getElementById("pwm2"),
  document.getElementById("pwm3"),
  document.getElementById("pwm4"),
  document.getElementById("pwm5"),
  document.getElementById("pwm6"),
  document.getElementById("pwm7")
];

function setLatLon(lat,lon){
  latI.value=String(lat);
  lonI.value=String(lon);
}

/* -------------------------------------------------
   Radius Model (same as Arduino)
------------------------------------------------- */
function computeFallTime(h,vt){
  if(vt<=0.1) return Math.sqrt((2*h)/9.80665);
  const G=9.80665;
  let a=(G*h)/(vt*vt);
  if(a<1e-4) return Math.sqrt((2*h)/G);
  if(a>80) a=80;

  const ex=Math.exp(a);
  const inner=ex*ex -1;
  const ac=Math.log(ex + Math.sqrt(inner>=0?inner:0));
  return (vt/G)*ac;
}

function estimateVT(m){
  if(m<=0.30) return 18;
  if(m<=0.50) return 22.5;
  if(m<=0.60) return 24.7;
  if(m<=0.70) return 26.7;
  if(m<=1.00) return 28.5;
  if(m<=2.00) return 32;
  return 38;
}

function computeDropRadius(v,h,m){
  const vt=estimateVT(m);
  const t=computeFallTime(h,vt);
  return v*t*1.22;
}

/* -------------------------------------------------
   Draw Circle
------------------------------------------------- */
function drawDropCircle(lat,lon,r){
  if(dropCircle){
    map.removeLayer(dropCircle);
    dropCircle=null;
  }
  if(r<=0) return;

  dropCircle=L.circle([lat,lon],{
    radius:r,
    color:"#7aa2ff",
    weight:2,
    fillColor:"#7aa2ff",
    fillOpacity:0.15
  }).addTo(map);
}

/* -------------------------------------------------
   Update radius when inputs change
------------------------------------------------- */
function updateRadiusCircleFromInputs(){
  const lat=parseFloat(latI.value);
  const lon=parseFloat(lonI.value);
  const v=parseFloat(vI.value);
  const h=parseFloat(hI.value);
  const offset=parseFloat(offsetI.value||0);
  const mass=parseFloat(massI.value||0.757);

  if(isNaN(lat)||isNaN(lon)||isNaN(v)||isNaN(h)) return;

  const base=computeDropRadius(v,h,mass);
  const eff=base+offset;
  drawDropCircle(lat,lon,eff);
}

/* 실시간 반응 */
[vI,hI,offsetI,massI].forEach(i=>{
  i.addEventListener("input",updateRadiusCircleFromInputs);
});
latI.addEventListener("change",updateRadiusCircleFromInputs);
lonI.addEventListener("change",updateRadiusCircleFromInputs);

/* -------------------------------------------------
   Serial
------------------------------------------------- */
let port=null,reader=null,writer=null;
let closing=false;
const logEl=document.getElementById("log");
const encoder=new TextEncoder();

function log(msg,color){
  const d=document.createElement("div");
  if(color) d.style.color=color;
  d.textContent=msg;
  logEl.appendChild(d);
  logEl.scrollTop=logEl.scrollHeight;
}

const portDot=document.getElementById("portDot");
const portLbl=document.getElementById("portLbl");
const btnDisconnect=document.getElementById("btnDisconnect");

function setPortStatus(on){
  portDot.className="stat-dot "+(on?"dot-ok":"dot-err");
  portLbl.textContent=on?"Connected":"Disconnected";
  btnDisconnect.disabled=!on;
}

async function safeTearDown(){
  try{ if(reader){ await reader.cancel(); reader.releaseLock(); } }catch{}
  reader=null;
  try{ if(writer){ await writer.close(); writer.releaseLock(); } }catch{}
  writer=null;
  try{ if(port){ await port.close(); } }catch{}
  port=null;
}

async function connectSerial(){
  if(!("serial" in navigator)){
    alert("Chrome 필요");
    return;
  }
  try{
    port=await navigator.serial.requestPort();
    await port.open({baudRate:115200});
    writer=port.writable.getWriter();
    reader=port.readable.getReader();
    setPortStatus(true);
    log("> 연결됨","#9be5a3");
    readLoop();
  }catch(e){
    log("> ERR: "+e,"#ff8b8b");
    await safeTearDown();
    setPortStatus(false);
  }
}

async function disconnectSerial(){
  closing=true;
  try{
    if(reader){ await reader.cancel(); reader.releaseLock(); reader=null; }
    if(writer){ await writer.close(); writer.releaseLock(); writer=null; }
    if(port){ await port.close(); }
    port=null;
    setPortStatus(false);
    log("> 연결 해제","#ffc857");
  }finally{
    closing=false;
  }
}

async function readLoop(){
  while(reader){
    try{
      const {value,done}=await reader.read();
      if(done) break;
      if(value){
        new TextDecoder().decode(value)
          .split(/\r?\n/)
          .forEach(l=>l && log(l));
      }
    }catch{
      break;
    }
  }
}

async function sendLine(s){
  if(!writer){
    log("> ERR: 연결 안됨","#ff8b8b");
    return;
  }
  try{
    await writer.write(encoder.encode(s+"\n"));
    log("> "+s,"#9bb1d6");
  }catch(e){
    log("> ERR "+e,"#ff8b8b");
  }
}

/* -------------------------------------------------
   PARAM LINE (OLED 정상 표기용)
------------------------------------------------- */

/* 빈 값 보정 함수 */
function fixNumber(v, def){
  if(v.trim()==="") return def;
  const n=parseFloat(v);
  return isNaN(n) ? def : n;
}
function fixPWM(v){
  if(v.trim()==="") return 1500;
  const n=parseInt(v);
  return isNaN(n) ? 1500 : n;
}

function buildParamLine(){
  const lat = latI.value.trim();
  const lon = lonI.value.trim();

  const v = fixNumber(vI.value,"0");
  const h = fixNumber(hI.value,"0");
  const hold = fixNumber(holdI.value,"0.1");
  const offset = fixNumber(offsetI.value,"0");
  const mass = fixNumber(massI.value,"0.757");

  const pwm = pwmI.map(x => fixPWM(x.value));

  /* 지도 반경 업데이트 */
  updateRadiusCircleFromInputs();

  /* 반드시 15개 */
  return [
    lat, lon,
    v, h,
    hold, offset,
    mass,
    pwm[0], pwm[1], pwm[2], pwm[3], pwm[4], pwm[5], pwm[6]
  ].join(" ");
}

/* -------------------------------------------------
   Buttons
------------------------------------------------- */
document.getElementById("btnConnect").onclick=connectSerial;
document.getElementById("btnDisconnect").onclick=disconnectSerial;

document.getElementById("btnSend").onclick=()=>{
  const line=buildParamLine();
  sendLine(line);
};

document.getElementById("btnReset").onclick=()=>{
  setLatLon(INIT.lat,INIT.lon);
  moveMarker(INIT.lat,INIT.lon,true);

  vI.value=hI.value=holdI.value=offsetI.value=massI.value="";
  pwmI.forEach(i => i.value="");

  if(dropCircle) map.removeLayer(dropCircle);
  dropCircle=null;

  log("> UI Reset","#9bb1d6");
};

/* -------------------------------------------------
   Init View
------------------------------------------------- */
moveMarker(INIT.lat,INIT.lon,true);
setLatLon(INIT.lat,INIT.lon);
setPortStatus(false);

</script>
</body>
</html>
